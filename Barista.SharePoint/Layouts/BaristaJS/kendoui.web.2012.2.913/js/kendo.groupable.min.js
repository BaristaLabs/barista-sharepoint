/*
* Kendo UI Web v2012.2.913 (http://kendoui.com)
* Copyright 2012 Telerik AD. All rights reserved.
*
* Kendo UI Web commercial licenses may be obtained at
* https://www.kendoui.com/purchase/license-agreement/kendo-ui-web-commercial.aspx
* If you do not own a commercial license, this file shall be governed by the
* GNU General Public License (GPL) version 3.
* For GPL requirements, please review: http://www.gnu.org/copyleft/gpl.html
*/
;(function(a,b){function k(a){return a.position().top+3}var c=window.kendo,d=c.ui.Widget,e=a.proxy,f=".kendoGroupable",g=c.template('<div class="k-group-indicator" data-#=data.ns#field="${data.field}" data-#=data.ns#title="${data.title || ""}" data-#=data.ns#dir="${data.dir || "asc"}"><a href="\\#" class="k-link"><span class="k-icon k-si-arrow-${(data.dir || "asc") == "asc" ? "n" : "s"}">(sorted ${(data.dir || "asc") == "asc" ? "ascending": "descending"})</span>${data.title ? data.title: data.field}</a><a class="k-button k-button-icon k-button-bare"><span class="k-icon k-group-delete"></span></a></div>',{useWithBlock:!1}),h=function(b){return a('<div class="k-header k-drag-clue" />').css({width:b.width(),paddingLeft:b.css("paddingLeft"),paddingRight:b.css("paddingRight"),lineHeight:b.height()+"px",paddingTop:b.css("paddingTop"),paddingBottom:b.css("paddingBottom")}).html(b.attr(c.attr("title"))||b.attr(c.attr("field"))).prepend('<span class="k-icon k-drag-status k-denied" />')},i=a('<div class="k-grouping-dropclue"/>'),j=/(\[|\]|\$|\.|\:|\+)/g,l=d.extend({init:function(b,g){var j=this,l,m=c.guid(),n=e(j._intializePositions,j),o,p=j._dropCuePositions=[];d.fn.init.call(j,b,g),o=j.options.draggable||new c.ui.Draggable(j.element,{filter:j.options.filter,hint:h,group:m}),l=j.groupContainer=a(j.options.groupContainer,j.element).kendoDropTarget({group:o.options.group,dragenter:function(a){j._canDrag(a.draggable.currentTarget)&&(a.draggable.hint.find(".k-drag-status").removeClass("k-denied").addClass("k-add"),i.css({top:k(l),left:0}).appendTo(l))},dragleave:function(a){a.draggable.hint.find(".k-drag-status").removeClass("k-add").addClass("k-denied"),i.remove()},drop:function(b){var d=b.draggable.currentTarget,e=d.attr(c.attr("field")),f=d.attr(c.attr("title")),g=j.indicator(e),h=j._dropCuePositions,k=h[h.length-1],l;if(!!d.hasClass("k-group-indicator")||!!j._canDrag(d))k?(l=j._dropCuePosition(i.offset().left+parseInt(k.element.css("marginLeft"),10)+parseInt(k.element.css("marginRight"),10)),l&&j._canDrop(a(g),l.element,l.left)&&(l.before?l.element.before(g||j.buildIndicator(e,f)):l.element.after(g||j.buildIndicator(e,f)),j._change())):(j.groupContainer.append(j.buildIndicator(e,f)),j._change())}}).kendoDraggable({filter:"div.k-group-indicator",hint:h,group:o.options.group,dragcancel:e(j._dragCancel,j),dragstart:function(a){var b=a.currentTarget,c=parseInt(b.css("marginLeft"),10),d=b.position().left-c;n(),i.css({top:k(l),left:d}).appendTo(l),this.hint.find(".k-drag-status").removeClass("k-denied").addClass("k-add")},dragend:function(){j._dragEnd(this)},drag:e(j._drag,j)}).on("click"+f,".k-button",function(b){b.preventDefault(),j._removeIndicator(a(this).parent())}).on("click"+f,".k-link",function(b){var d=a(this).parent(),e=j.buildIndicator(d.attr(c.attr("field")),d.attr(c.attr("title")),d.attr(c.attr("dir"))=="asc"?"desc":"asc");d.before(e).remove(),j._change(),b.preventDefault()}),o.bind(["dragend","dragcancel","dragstart","drag"],{dragend:function(){j._dragEnd(this)},dragcancel:e(j._dragCancel,j),dragstart:function(a){var b,c,d;!j.options.allowDrag&&!j._canDrag(a.currentTarget)?a.preventDefault():(n(),p.length?(b=p[p.length-1].element,c=parseInt(b.css("marginRight"),10),d=b.position().left+b.outerWidth()+c):d=0)},drag:e(j._drag,j)}),j.dataSource=j.options.dataSource,j.dataSource&&(j._refreshHandler=e(j.refresh,j),j.dataSource.bind("change",j._refreshHandler))},refresh:function(){var b=this,d=b.dataSource;b.groupContainer.empty().append(a.map(d.group()||[],function(a){var d=a.field.replace(j,"\\$1"),e=b.element.find(b.options.filter).filter("["+c.attr("field")+"="+d+"]");return b.buildIndicator(a.field,e.attr(c.attr("title")),a.dir)}).join("")),b._invalidateGroupContainer()},destroy:function(){var a=this;d.fn.destroy.call(a),a.groupContainer.off(f).kendoDraggable("destroy"),a.dataSource&&a._refreshHandler&&a.dataSource.unbind("change",a._refreshHandler)},options:{name:"Groupable",filter:"th",messages:{empty:"Drag a column header and drop it here to group by that column"}},indicator:function(b){var d=a(".k-group-indicator",this.groupContainer);return a.grep(d,function(d){return a(d).attr(c.attr("field"))===b})[0]},buildIndicator:function(a,b,d){return g({field:a,dir:d,title:b,ns:c.ns})},descriptors:function(){var b=this,d=a(".k-group-indicator",b.groupContainer),e,f,g,h,i;e=b.element.find(b.options.filter).map(function(){var b=a(this),d=b.attr(c.attr("aggregates")),e=b.attr(c.attr("field"));if(d&&d!==""){f=d.split(","),d=[];for(h=0,i=f.length;h<i;h++)d.push({field:e,aggregate:f[h]})}return d}).toArray();return a.map(d,function(b){b=a(b),g=b.attr(c.attr("field"));return{field:g,dir:b.attr(c.attr("dir")),aggregates:e||[]}})},_removeIndicator:function(a){var b=this;a.remove(),b._invalidateGroupContainer(),b._change()},_change:function(){var a=this;a.dataSource&&a.dataSource.group(a.descriptors())},_dropCuePosition:function(b){var c=this._dropCuePositions;if(!!i.is(":visible")&&c.length!==0){b=Math.ceil(b);var d=c[c.length-1],e=d.right,f=parseInt(d.element.css("marginLeft"),10),g=parseInt(d.element.css("marginRight"),10);b>=e?b={left:d.element.position().left+d.element.outerWidth()+g,element:d.element,before:!1}:(b=a.grep(c,function(a){return a.left<=b&&b<=a.right})[0],b&&(b={left:b.element.position().left-f,element:b.element,before:!0}));return b}},_drag:function(a){var b=c.touchLocation(a),d=this._dropCuePosition(b.x);d&&i.css({left:d.left})},_canDrag:function(a){var b=a.attr(c.attr("field"));return a.attr(c.attr("groupable"))!="false"&&b&&(a.hasClass("k-group-indicator")||!this.indicator(b))},_canDrop:function(a,b,c){var d=a.next();return a[0]!==b[0]&&(!d[0]||b[0]!==d[0]||c>d.position().left)},_dragEnd:function(b){var d=this,e=b.currentTarget.attr(c.attr("field")),f=d.indicator(e);b!==d.options.draggable&&!b.dropped&&f&&d._removeIndicator(a(f)),d._dragCancel()},_dragCancel:function(){i.remove(),this._dropCuePositions=[]},_intializePositions:function(){var b=this,c=a(".k-group-indicator",b.groupContainer),d;b._dropCuePositions=a.map(c,function(b){b=a(b),d=b.offset().left;return{left:parseInt(d,10),right:parseInt(d+b.outerWidth(),10),element:b}})},_invalidateGroupContainer:function(){var a=this.groupContainer;a.is(":empty")&&a.html(this.options.messages.empty)}});c.ui.plugin(l)})(jQuery);